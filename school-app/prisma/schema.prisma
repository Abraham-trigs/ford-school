generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ------------------ ENUMS ------------------

enum AttendanceSessionType {
  STUDENT_CLASS
  STAFF_WORK
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum PaymentType {
  DAILY
  WEEKLY
  MONTHLY
  TERM
  YEARLY
  ONE_TIME
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  MOBILE_MONEY
  CARD
  CHEQUE
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  FAILED
  REFUNDED
}

enum InvoiceStatus {
  UNPAID
  PARTIALLY_PAID
  PAID
  CANCELLED
}

enum ReceiptType {
  FULL_PAYMENT
  PART_PAYMENT
  REFUND
}

enum ReceiptStatus {
  ISSUED
  REPRINTED
  CANCELLED
}

enum ExamType {
  MIDTERM
  ENDTERM
  MOCK
  FINAL
  WAEC
  OTHER
}

enum PromotionDecision {
  PROMOTED
  REPEATED
  WITHHELD
}

enum AssetCategory {
  CLASSROOM
  LAB
  LIBRARY
  KITCHEN
  OFFICE
  TRANSPORT
  OTHER
}

enum AssetCondition {
  NEW
  GOOD
  FAIR
  POOR
  DAMAGED
}

enum AssetAction {
  ADDED
  REMOVED
  MAINTENANCE
  TRANSFER
  DISPOSED
}

enum VisitorStatus {
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
}

enum EventType {
  HOLIDAY
  EXAM
  ASSEMBLY
  CELEBRATION
  MEETING
  OTHER
}

enum LibraryAction {
  BORROWED
  RETURNED
  LOST
  DAMAGED
  ADDED
}

enum DisciplineType {
  WARNING
  SUSPENSION
  EXPULSION
  NOTE
}

enum ClassActivityType {
  CLASSWORK
  HOMEWORK
  EXTRA_CLASS
  EXAM
}

// ------------------ CORE MODELS ------------------

model SessionData {
  id             String   @id @default(cuid())
  user           User     @relation(fields: [userId], references: [id])
  userId         String

  // Session management
  sessionKey     String   @unique
  device         String?  // device/browser info, e.g., "Chrome MacOS"
  ip             String?  // optional IP tracking
  createdAt      DateTime @default(now())
  expiresAt      DateTime // optional expiration

  // In-App activity
  pagesVisited   Json?    // array of app pages visited [{page: "/dashboard", timestamp: "..."}]
  clicks         Json?    // array of clicks [{elementId: "btnSubmit", timestamp: "..."}]
  keyboardInputs Json?    // per page inputs [{page: "/form", input: "abc", timestamp: "..."}]
  bookmarks      Json?    // bookmarks saved inside the app [{page: "/lesson/1", title: "..."}]

  // Browser-level activity (consent required)
  externalPagesVisited Json? // tracks external pages visited [{url: "...", timestamp: "..."}]
  localStorageData    Json? // snapshot of localStorage (non-sensitive)
  sessionStorageData  Json? // snapshot of sessionStorage (non-sensitive)
  cookiesData         Json? // non-sensitive cookies

  // Optional analytics
  mouseMovements      Json? // mouse movements captured inside app
  scrollPositions     Json? // per page scroll positions
  activeTime          Int?  // total active time in seconds

  // Relations
  userSessionUpdates  SessionUpdate[] // logs updates or refreshes per session

  @@index([userId])
  @@index([sessionKey])
}

model SessionUpdate {
  id            String      @id @default(cuid())
  session       SessionData @relation(fields: [sessionId], references: [id])
  sessionId     String
  updatedAt     DateTime    @default(now())
  updateReason  String      // e.g., "manual refresh", "auto-refresh", "permission change"
}


// Dynamic User Statuses
model UserStatus {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users     User[]
}


// Dynamic Roles
model RoleModel {
  id          String       @id @default(cuid())
  name        String       @unique
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Self-relation Many-to-Many
  relatedRoles RoleModel[] @relation("RoleRelations")
  relatedBy    RoleModel[] @relation("RoleRelations")

  users       User[]
  permissions RolePermission[]
}

// User
model User {
  id           String    @id @default(cuid())
  name         String
  email        String?   @unique
  phone        String?
  password     String
  sessions     SessionData[] // back-relation for SessionData

  roleId       String
  role         RoleModel @relation(fields: [roleId], references: [id])

  statusId     String
  status       UserStatus @relation(fields: [statusId], references: [id])

  profilePic   String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  staff        Staff?
  student      Student?
  parentOf     Student[] @relation("UserParentOf")
  parents      Student[] @relation("UserParents")

  payments        Payment[] @relation("PaymentUser")
  issuedPayments  Payment[] @relation("PaymentIssuer")
  invoices        Invoice[]
  attendanceRecords AttendanceRecord[]

  createdEvents   SchoolEvent[] @relation("EventCreator")
  events          SchoolEvent[] @relation("EventParticipants")

  borrowedBooks   LibraryLog[] @relation("LibraryUser")
  drivingVehicles TransportVehicle[] @relation("VehicleDriver")
  issuedDisciplineLogs DisciplineLog[] @relation("DisciplineIssuer")
  createdAnnouncements Announcement[]

  createdVisitorLogs  VisitorLog[] @relation("VisitorCreated")
  visitedVisitorLogs  VisitorLog[] @relation("VisitorVisited")
  approvedVisitorLogs VisitorLog[] @relation("VisitorApproved")

  classActivities ClassActivity[] @relation("ClassActivityTeacher")

  attendanceSessionsTaken AttendanceSession[] @relation("AttendanceTeacher")
  promotionsDecided       Promotion[] @relation("PromotionDecider")
  schoolExpensesPaid      SchoolExpense[] @relation("ExpensePaidBy")
  schoolIncomesRecorded   SchoolIncome[] @relation("IncomeRecordedBy")
  departments             Department[] @relation("DepartmentOwner")
  sectionsTaught          Section[] @relation("SectionTeacher")
  timetables              Timetable[] @relation("TimetableTeacher")

  performedAssetLogs AssetLog[]

  @@index([roleId])
  @@index([statusId])
}

// ------------------ STAFF/STUDENT ------------------

model Staff {
  id        String   @id @default(cuid())
  userId    String   @unique
  position  String
  user      User     @relation(fields: [userId], references: [id])
  salaries  StaffSalary[] @relation("SalaryIssuer")
  departments Department[] @relation("DepartmentStaff")

  @@index([userId])
}

model Student {
  id        String   @id @default(cuid())
  userId    String   @unique
  sectionId String
  rollNo    String
  user      User     @relation(fields: [userId], references: [id])
  section   Section  @relation(fields: [sectionId], references: [id])
  parents   User[]   @relation("UserParents")
  parentOf  User[]   @relation("UserParentOf")
  promotions Promotion[]
  classActivities ClassActivity[]

  @@unique([rollNo, sectionId])
  @@index([sectionId])
}

// ------------------ SECTION ------------------

model Section {
  id        String    @id @default(cuid())
  name      String
  students  Student[]
  teacherId String?
  teacher   User?     @relation("SectionTeacher", fields: [teacherId], references: [id])
  attendanceSessions AttendanceSession[] @relation("AttendanceSection")
  exams     Exam[]
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  timetables   Timetable[]

  @@index([teacherId])
  @@index([departmentId])
}

// ------------------ ATTENDANCE ------------------

model AttendanceRecord {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  status    AttendanceStatus
  date      DateTime
  sessionId String?
  session   AttendanceSession? @relation("AttendanceSessionRecords", fields: [sessionId], references: [id])

  @@index([userId])
  @@index([sessionId])
  @@index([status])
}

model AttendanceSession {
  id        String                @id @default(cuid())
  type      AttendanceSessionType
  teacherId String
  teacher   User                  @relation("AttendanceTeacher", fields: [teacherId], references: [id])
  sectionId String
  section   Section               @relation("AttendanceSection", fields: [sectionId], references: [id])
  records   AttendanceRecord[] @relation("AttendanceSessionRecords")

  @@index([teacherId])
  @@index([sectionId])
  @@index([type])
}

// ------------------ ACADEMIC MODELS ------------------

model Subject {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  classActivities ClassActivity[]
  timetables       Timetable[]
}

model Exam {
  id         String @id @default(cuid())
  title      String
  sectionId  String
  section    Section @relation(fields: [sectionId], references: [id])
  startDate  DateTime
  endDate    DateTime
  examType   ExamType

  classActivities ClassActivity[] @relation("ExamActivities")

  @@index([sectionId])
  @@index([examType])
}

// ------------------ CLASS ACTIVITIES ------------------

model ClassActivity {
  id        String   @id @default(cuid())
  studentId String
  student   Student  @relation(fields: [studentId], references: [id])

  subjectId String
  subject   Subject  @relation(fields: [subjectId], references: [id])

  teacherId String
  teacher   User     @relation("ClassActivityTeacher", fields: [teacherId], references: [id])

  type      ClassActivityType
  examId    String?  // optional link to an Exam if type === EXAM
  exam      Exam?    @relation("ExamActivities", fields: [examId], references: [id])

  score     Float?
  remarks   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, subjectId, type, createdAt]) 
  @@index([studentId])
  @@index([subjectId])
  @@index([teacherId])
  @@index([type])
  @@index([examId])
}


// ------------------ FINANCE MODELS ------------------

model Payment {
  id          String      @id @default(cuid())
  amount      Float
  paymentType PaymentType
  method      PaymentMethod
  status      PaymentStatus @default(PENDING)
  transactionRef String?   @unique
  userId      String
  user        User        @relation("PaymentUser", fields: [userId], references: [id])
  issuedById  String?
  issuedBy    User?       @relation("PaymentIssuer", fields: [issuedById], references: [id])
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([userId])
  @@index([issuedById])
  @@index([status])
}

model Invoice {
  id          String       @id @default(cuid())
  amount      Float
  status      InvoiceStatus @default(UNPAID)
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  receipts    Receipt[]

  @@index([userId])
  @@index([status])
}

model Receipt {
  id        String      @id @default(cuid())
  invoiceId String?
  invoice   Invoice?    @relation(fields: [invoiceId], references: [id])
  type      ReceiptType
  status    ReceiptStatus @default(ISSUED)
  issuedAt  DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@index([invoiceId])
  @@index([status])
}

model StaffSalary {
  id         String @id @default(cuid())
  staffId    String
  staff      Staff @relation("SalaryIssuer", fields: [staffId], references: [id])
  amount     Float
  payPeriod  PaymentType
  status     PaymentStatus @default(PENDING)
  method     PaymentMethod
  updatedAt  DateTime @updatedAt

  @@index([staffId])
  @@index([status])
}

model SchoolExpense {
  id        String @id @default(cuid())
  purpose   String
  amount    Float
  paidById  String?
  paidBy    User? @relation("ExpensePaidBy", fields: [paidById], references: [id])
  expenseDate DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([paidById])
}

model SchoolIncome {
  id           String @id @default(cuid())
  description  String
  amount       Float
  receivedFrom String?
  paymentMethod PaymentMethod
  recordedById String?
  recordedBy   User? @relation("IncomeRecordedBy", fields: [recordedById], references: [id])
  receivedAt   DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([recordedById])
}

// ------------------ SCHOOL OPERATIONS ------------------

model Department {
  id        String @id @default(cuid())
  name      String
  staff     Staff[] @relation("DepartmentStaff")
  sections  Section[]
  ownerId   String?
  owner     User? @relation("DepartmentOwner", fields: [ownerId], references: [id])

  @@index([ownerId])
}

model Asset {
  id          String @id @default(cuid())
  name        String
  description String?
  category    AssetCategory
  condition   AssetCondition
  quantity    Int     @default(1)
  location    String?
  updatedAt   DateTime @updatedAt
}

model AssetLog {
  id           String @id @default(cuid())
  assetId      String
  action       AssetAction
  notes        String?
  performedById String
  performedBy  User @relation(fields: [performedById], references: [id])
  createdAt    DateTime @default(now())

  @@index([assetId])
  @@index([performedById])
}

model VisitorLog {
  id            String @id @default(cuid())
  visitorName   String
  phone         String?
  email         String?
  checkIn       DateTime @default(now())
  checkOut      DateTime?
  purpose       String
  visitedUserId String?
  visitedUser   User? @relation("VisitorVisited", fields: [visitedUserId], references: [id])
  status        VisitorStatus @default(CHECKED_IN)
  notes         String?
  createdById   String
  createdBy     User @relation("VisitorCreated", fields: [createdById], references: [id])
  approvedById  String?
  approvedBy    User? @relation("VisitorApproved", fields: [approvedById], references: [id])

  @@index([visitedUserId])
  @@index([createdById])
  @@index([approvedById])
  @@index([status])
}

model SchoolEvent {
  id          String @id @default(cuid())
  title       String
  description String?
  eventType   EventType
  startDate   DateTime
  endDate     DateTime
  isPublic    Boolean @default(true)
  createdById String
  createdBy   User   @relation("EventCreator", fields: [createdById], references: [id])
  participants User[] @relation("EventParticipants")

  @@index([createdById])
  @@index([eventType])
}

model Timetable {
  id        String   @id @default(cuid())
  sectionId String
  section   Section  @relation(fields: [sectionId], references: [id])
  teacherId String
  teacher   User     @relation("TimetableTeacher", fields: [teacherId], references: [id])
  subjectId String
  subject   Subject  @relation(fields: [subjectId], references: [id])
  startTime DateTime
  endTime   DateTime
  day       String

  @@index([sectionId])
  @@index([teacherId])
  @@index([subjectId])
}


model LibraryLog {
  id        String @id @default(cuid())
  bookId    String
  userId    String
  user      User @relation("LibraryUser", fields: [userId], references: [id])
  action    LibraryAction
  borrowedAt DateTime @default(now())
  returnedAt DateTime?

  @@index([bookId])
  @@index([userId])
  @@index([action])
}

model TransportVehicle {
  id        String @id @default(cuid())
  name      String
  capacity  Int
  driverId  String?
  driver    User? @relation("VehicleDriver", fields: [driverId], references: [id])
  acquiredAt DateTime?
  condition  AssetCondition
  updatedAt  DateTime @updatedAt

  @@index([driverId])
}

model DisciplineLog {
  id        String @id @default(cuid())
  studentId String?
  issuedById String
  issuedBy  User @relation("DisciplineIssuer", fields: [issuedById], references: [id])
  type      DisciplineType
  notes     String?
  createdAt DateTime @default(now())

  @@index([studentId])
  @@index([issuedById])
  @@index([type])
}

model Announcement {
  id          String @id @default(cuid())
  content     String
  createdById String
  createdBy   User @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([createdById])
}

model Promotion {
  id          String @id @default(cuid())
  studentId   String
  student     Student @relation(fields: [studentId], references: [id])
  term        Int?
  decision    PromotionDecision
  decidedById String
  decidedBy   User @relation("PromotionDecider", fields: [decidedById], references: [id])

  @@index([studentId])
  @@index([decidedById])
  @@index([decision])
}

// ------------------ ROLE-BASED ACCESS CONTROL ------------------

model RolePermission {
  id        String      @id @default(cuid())
  roleId    String
  role      RoleModel   @relation(fields: [roleId], references: [id])

  actions   String[]    // ["read", "create", "update", "delete"]
  resources RolePermissionResource[] @relation("PermissionResources")
  
  // Optional group-based access to reduce per-record entries
  groupType String?     // e.g., "SECTION", "DEPARTMENT", "GLOBAL"
  groupId   String?     // ID of section/department if applicable

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([roleId])
  @@index([groupType, groupId])
}

model RolePermissionResource {
  id           String @id @default(cuid())
  permissionId String
  permission   RolePermission @relation("PermissionResources", fields: [permissionId], references: [id])
  resourceName String           // e.g., "Student", "Invoice", "ClassActivity"

  // Only store exceptions here; otherwise, use groupType/groupId in RolePermission
  allowedRecords RolePermissionRecord[] @relation("ResourceAllowedRecords")

  @@index([permissionId])
  @@index([resourceName])
}

model RolePermissionRecord {
  id         String @id @default(cuid())
  resourceId String
  resource   RolePermissionResource @relation("ResourceAllowedRecords", fields: [resourceId], references: [id])
  recordId   String // actual ID of the record (e.g., Student.id, Invoice.id)

  @@index([resourceId, recordId])
}

